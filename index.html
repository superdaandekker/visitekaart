<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digitale Kaart – Mijn kaart</title>
  <script>
    if (!localStorage.getItem('user:email')) {
      window.location.replace('home.html');
    }
  </script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="nav">
      <a class="site-title" href="index.html">Digitale Kaart</a>
      <nav class="site-nav" aria-label="Hoofdnavigatie">
        <a href="dashboard.html">Dashboard</a>
        <a href="index.html" class="active" data-auth-link>Mijn kaart</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="page-intro">
        <div class="actions">
          <div class="stack">
            <h1>Mijn kaart</h1>
            <p class="muted">Bewerk je gegevens en deel je digitale visitekaart.</p>
          </div>
          <button type="button" class="btn btn-secondary push-end" id="logoutBtn" hidden>Uitloggen</button>
        </div>
      </section>

      <div class="split two">
        <section class="card" aria-labelledby="previewTitle">
          <div class="card-header">
            <div>
              <h2 id="previewTitle">Voorbeeldkaart</h2>
              <p class="card-subtext">Zo ziet je visitekaart eruit.</p>
            </div>
            <div class="actions">
              <button type="button" class="btn btn-secondary" id="btnShare">Delen</button>
              <button type="button" class="btn" id="btnVCard">Download vCard</button>
            </div>
          </div>
          <div class="card-content">
            <div class="actions">
              <img id="avatarPreview" class="avatar" alt="Profielfoto" />
              <div class="stack">
                <p id="namePreview" class="card-name">Jouw Naam</p>
                <p id="titlePreview" class="card-role">Functie</p>
                <p id="companyPreview" class="card-company">Bedrijf</p>
                <div class="contact-links">
                  <a href="#" id="emailLink">E-mail</a>
                  <a href="#" id="telLink">Telefoon</a>
                  <a href="#" id="webLink">Website</a>
                  <a href="#" id="liLink">LinkedIn</a>
                  <a href="#" id="igLink">Instagram</a>
                </div>
              </div>
            </div>
            <p id="tagline" class="tagline muted" hidden></p>
          </div>
        </section>

        <section class="card" aria-labelledby="editTitle">
          <div class="card-header">
            <div>
              <h2 id="editTitle">Bewerken</h2>
              <p class="card-subtext">Wijzigingen worden automatisch opgeslagen.</p>
            </div>
            <span class="pill">Opslaan: automatisch</span>
          </div>
          <form id="editForm" class="card-content">
            <div class="field-grid two">
              <div>
                <label for="fieldName">Naam</label>
                <input id="fieldName" name="name" placeholder="Jouw Naam" />
              </div>
              <div>
                <label for="fieldTitle">Functie</label>
                <input id="fieldTitle" name="title" placeholder="Bijv. Founder" />
              </div>
            </div>
            <div class="field-grid two">
              <div>
                <label for="fieldCompany">Bedrijf</label>
                <input id="fieldCompany" name="company" placeholder="Bedrijfsnaam" />
              </div>
              <div>
                <label for="fieldWebsite">Website</label>
                <input id="fieldWebsite" name="website" placeholder="https://..." />
              </div>
            </div>
            <div class="field-grid two">
              <div>
                <label for="fieldEmail">E-mailadres</label>
                <input id="fieldEmail" name="email" type="email" placeholder="jij@voorbeeld.nl" />
              </div>
              <div>
                <label for="fieldPhone">Telefoon</label>
                <input id="fieldPhone" name="phone" placeholder="+31..." />
              </div>
            </div>
            <div class="field-grid two">
              <div>
                <label for="fieldLinkedIn">LinkedIn</label>
                <input id="fieldLinkedIn" name="linkedin" placeholder="https://linkedin.com/in/..." />
              </div>
              <div>
                <label for="fieldInstagram">Instagram</label>
                <input id="fieldInstagram" name="instagram" placeholder="https://instagram.com/..." />
              </div>
            </div>
            <div>
              <label for="fieldAvatar">Profielfoto (URL)</label>
              <input id="fieldAvatar" name="avatar" placeholder="https://...jpg" />
            </div>
            <div>
              <label for="fieldBio">Korte bio / tagline</label>
              <textarea id="fieldBio" name="bio" rows="3" placeholder="Wat doe jij?"></textarea>
            </div>
            <div class="actions">
              <button type="button" class="btn btn-secondary" id="btnGenerate">Genereer met AI</button>
              <span class="supporting-text">Opslaan gebeurt automatisch.</span>
            </div>
          </form>
          <div class="notice" role="note">
            <strong>Let op:</strong>
            <p class="supporting-text">De knop <em>Genereer met AI</em> verwacht een serverless endpoint op <code>/api/generate</code> dat jouw OpenAI-sleutel gebruikt. Zie het commentaar in de code hieronder.</p>
          </div>
        </section>
      </div>

      <footer class="page-footer">Made for Codex: laat deze repo door Codex uitbreiden met hosting, serverless functies en CI.</footer>
    </div>
  </main>
  <script>
    const logoutBtn = document.getElementById('logoutBtn');
    const storedEmail = localStorage.getItem('user:email');
    if (storedEmail) {
      logoutBtn.hidden = false;
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('user:email');
        window.location.replace('home.html');
      });
    }

    const authLink = document.querySelector('[data-auth-link]');
    if (authLink) {
      authLink.setAttribute('href', storedEmail ? 'card.html' : 'index.html');
    }

    const form = document.getElementById('editForm');
    const fields = ['name', 'title', 'company', 'website', 'email', 'phone', 'linkedin', 'instagram', 'avatar', 'bio'];
    const els = {
      name: document.getElementById('fieldName'),
      title: document.getElementById('fieldTitle'),
      company: document.getElementById('fieldCompany'),
      website: document.getElementById('fieldWebsite'),
      email: document.getElementById('fieldEmail'),
      phone: document.getElementById('fieldPhone'),
      linkedin: document.getElementById('fieldLinkedIn'),
      instagram: document.getElementById('fieldInstagram'),
      avatar: document.getElementById('fieldAvatar'),
      bio: document.getElementById('fieldBio')
    };

    const preview = {
      name: document.getElementById('namePreview'),
      title: document.getElementById('titlePreview'),
      company: document.getElementById('companyPreview'),
      emailLink: document.getElementById('emailLink'),
      telLink: document.getElementById('telLink'),
      webLink: document.getElementById('webLink'),
      liLink: document.getElementById('liLink'),
      igLink: document.getElementById('igLink'),
      avatar: document.getElementById('avatarPreview'),
      tagline: document.getElementById('tagline')
    };

    function load() {
      try {
        const data = JSON.parse(localStorage.getItem('card:data') || '{}');
        fields.forEach((key) => {
          if (data[key]) {
            els[key].value = data[key];
          }
        });
        render();
      } catch (error) {
        console.warn(error);
      }
    }

    function save() {
      const data = Object.fromEntries(fields.map((key) => [key, els[key].value.trim()]));
      localStorage.setItem('card:data', JSON.stringify(data));
    }

    function render() {
      const data = Object.fromEntries(fields.map((key) => [key, els[key].value.trim()]));
      preview.name.textContent = data.name || 'Jouw Naam';
      preview.title.textContent = data.title || 'Functie';
      preview.company.textContent = data.company || 'Bedrijf';
      preview.emailLink.href = data.email ? `mailto:${data.email}` : '#';
      preview.emailLink.textContent = data.email || 'E‑mail';
      preview.telLink.href = data.phone ? `tel:${data.phone}` : '#';
      preview.telLink.textContent = data.phone || 'Telefoon';
      preview.webLink.href = data.website || '#';
      preview.webLink.textContent = data.website || 'Website';
      preview.liLink.href = data.linkedin || '#';
      preview.liLink.textContent = data.linkedin || 'LinkedIn';
      preview.igLink.href = data.instagram || '#';
      preview.igLink.textContent = data.instagram || 'Instagram';
      const fallbackAvatar = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="88" height="88"><rect width="100%" height="100%" fill="#0f1218"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#2e3440" font-family="Arial" font-size="12">Foto</text></svg>`);
      preview.avatar.src = data.avatar || fallbackAvatar;
      if (data.bio) {
        preview.tagline.textContent = data.bio;
        preview.tagline.hidden = false;
      } else {
        preview.tagline.textContent = '';
        preview.tagline.hidden = true;
      }
    }

    form.addEventListener('input', () => {
      save();
      render();
    });

    document.getElementById('btnVCard').addEventListener('click', () => {
      const data = Object.fromEntries(fields.map((key) => [key, els[key].value.trim()]));
      const vcard = [
        'BEGIN:VCARD',
        'VERSION:3.0',
        `FN:${data.name}`,
        `ORG:${data.company}`,
        `TITLE:${data.title}`,
        data.email ? `EMAIL;TYPE=INTERNET:${data.email}` : '',
        data.phone ? `TEL;TYPE=CELL:${data.phone}` : '',
        data.website ? `URL:${data.website}` : '',
        'END:VCARD'
      ].filter(Boolean).join('\n');
      const blob = new Blob([vcard], { type: 'text/vcard' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'visitekaart.vcf';
      link.click();
      URL.revokeObjectURL(link.href);
    });

    document.getElementById('btnShare').addEventListener('click', async () => {
      const shareUrl = new URL('card.html', window.location.href).href;
      const data = Object.fromEntries(fields.map((key) => [key, els[key].value.trim()]));
      const shareParts = [];
      if (data.name) shareParts.push(data.name);
      if (data.title) shareParts.push(data.title);
      if (data.company) shareParts.push(`@ ${data.company}`);
      const text = shareParts.join(' ') || 'Mijn digitale visitekaart';
      try {
        if (navigator.share) {
          await navigator.share({ title: document.title, text, url: shareUrl });
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(shareUrl);
          alert('Link naar je publieke kaart is gekopieerd naar het klembord.');
        } else {
          window.prompt('Kopieer deze link naar je kaart:', shareUrl);
        }
      } catch (error) {
        console.warn(error);
      }
    });

    document.getElementById('btnGenerate').addEventListener('click', async () => {
      const data = Object.fromEntries(fields.map((key) => [key, els[key].value.trim()]));
      try {
        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: data.name,
            title: data.title,
            company: data.company,
            website: data.website,
            tone: 'vriendelijk, beknopt'
          })
        });
        const json = await response.json();
        els.bio.value = json.text || json.output || '';
        save();
        render();
      } catch (error) {
        alert('Kon niet genereren. Configureer een serverless endpoint op /api/generate met jouw OpenAI‑sleutel.');
        console.error(error);
      }
    });

    /*
      === Serverless voorbeeld (Vercel /api/generate) ===

      // Bestand: api/generate.js
      import OpenAI from 'openai';
      const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

      export default async function handler(req, res){
        const { name, title, company, website, tone } = req.body || {};
        const userText = `Schrijf 1 korte, pakkende tagline (max 18 woorden) voor een digitale visitekaart van ${name||'iemand'}, ${title||''} bij ${company||''}. Toon: ${tone||'vriendelijk, professioneel'}.`;

        // Optie A: Responses API (aanbevolen in 2025)
        // const r = await client.responses.create({ model: 'gpt-4.1-mini', input: [{ role: 'user', content: userText }] });
        // const text = r.output_text; // of een vergelijkbaar veld

        // Optie B: Chat Completions API (fallback)
        const r = await client.chat.completions.create({
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: 'Je bent een copywriter die ultrakorte taglines schrijft.' },
            { role: 'user', content: userText }
          ]
        });
        const text = r.choices?.[0]?.message?.content?.trim();
        res.status(200).json({ text });
      }

      Zet in Vercel een environment variable: OPENAI_API_KEY.
      Laat Codex desgewenst deze endpoint omzetten naar de Responses API.
    */

    load();
  </script>
</body>
</html>
